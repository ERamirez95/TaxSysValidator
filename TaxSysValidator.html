<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Parcel/Bill Validator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            color-scheme: light dark;
        }

        body {
            font: 14px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
            margin: 0;
            padding: 10px;
        }

        label {
            display: block;
            margin: 0 0 6px;
            font-weight: 600;
        }

        input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 8px;
        }

        .msg {
            margin-top: 8px;
            min-height: 1.25rem;
        }

        .ok {
            color: #156c1e;
        }

        .bad {
            color: #9f1d1d;
        }

        .hint {
            opacity: .8;
            font-size: 12px;
            margin-top: 4px;
        }
    </style>
    <script src="https://js.jotform.com/JotFormCustomWidget.min.js"></script>
</head>
<body>
    <label for="num">Parcel or Bill Number</label>
    <input id="num" placeholder="Paste parcel or bill number" autocomplete="off" />
    <div id="m" class="msg">We’ll verify this before you submit.</div>
    <div id="standaloneHint" class="hint" style="display:none">(Opened outside Jotform.)</div>

    <script>
    // ===== LIVE ENDPOINTS =====
    const BASE = "https://zendeskfunctionapp-egfydygfdmavfxg9.westus-01.azurewebsites.net";
    const PARCEL_URL = (v) =>
      `${BASE}/api/parcels/${encodeURIComponent(v)}?code=HvcyDqdJg3iCJT-xt4AZ0wtGvJALITMb8JFCwiIYFOmtAzFul9CJrA==`;
    const BILL_URL = (v) =>
      `${BASE}/api/bills/${encodeURIComponent(v)}?code=PE97g8PBfTUnpfFBOGi1rlHrW2Ht9alomPv0D7Ub08vWAzFuA0XlPA==`;

    // ===== UI helpers =====
    const $ = (id) => document.getElementById(id);
    function say(t, cls = "") {
      const e = $("m"); if (!e) return;
      e.className = "msg " + cls;
      e.textContent = t;
    }
    function setVal(v) {
      if (window.JFCustomWidget && typeof JFCustomWidget.setValue === "function") {
        JFCustomWidget.setValue(v); // "parcel|…" or "bill|…", "" when invalid
      }
    }
    const debounce = (fn, ms) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; };

    async function getJson(url) {
      const res = await fetch(url, { method: "GET", mode: "cors", cache: "no-store" });
      let data = null; try { data = await res.json(); } catch {}
      return { status: res.status, ok: res.ok, data };
    }

    async function validateRaw(raw) {
      const v = (raw || "").replace(/[^\d]/g, "").trim(); // digits only
      if (!v) { setVal(""); say("Enter a parcel or bill number."); return; }
      say("Validating…");
      try {
        // 1) Try parcel
        let r = await getJson(PARCEL_URL(v));
        if (r.ok && (r.data?.exists === true || r.data?.ok === true)) {
          const n = r.data.normalized || r.data.parcel || v;
          setVal(`parcel|${n}`); say("✓ Valid parcel", "ok"); return;
        }
        // 2) Try bill
        r = await getJson(BILL_URL(v));
        if (r.ok && (r.data?.exists === true || r.data?.ok === true)) {
          const n = r.data.normalized || r.data.bill || v;
          setVal(`bill|${n}`); say("✓ Valid bill", "ok"); return;
        }
        setVal(""); say("✗ Invalid number", "bad");
      } catch {
        setVal(""); say("⚠ Error contacting validator", "bad");
      }
    }

    // ===== Robust, host-agnostic wiring =====
    (function bootstrap() {
      if (window.__taxSysValidatorInit) return;
      window.__taxSysValidatorInit = true;

      // Jotform lifecycle (safe even if not in Jotform)
      if (window.JFCustomWidget && typeof JFCustomWidget.subscribe === "function") {
        JFCustomWidget.subscribe("ready",  () => setVal(""));
        JFCustomWidget.subscribe("submit", () => JFCustomWidget.sendSubmit(true));
      } else {
        const showHint = () => { const hint = $("standaloneHint"); if (hint) hint.style.display = "block"; };
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", showHint, { once: true });
        } else {
          showHint();
        }
      }

      // Debounced validator shared by all events
      const validate = debounce((val) => validateRaw(val), 250);

      // Listen on document; only act when target is #num. Use capture so blur is caught.
      const onInputLike = (e) => {
        const t = e.target;
        if (t && t.id === "num") validate(t.value);
      };
      document.addEventListener("input",  onInputLike, true);
      document.addEventListener("change", onInputLike, true);
      document.addEventListener("blur",   onInputLike, true);

      // If field already exists with a value (prefill/paste), run once after paint
      const runInitial = () => {
        const el = $("num");
        if (el && el.value) validate(el.value);
      };
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", () => { queueMicrotask(runInitial); }, { once: true });
      } else {
        queueMicrotask(runInitial);
      }
    })();
    </script>
</body>
</html>
