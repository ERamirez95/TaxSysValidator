<script>
  const BASE = "https://zendeskfunctionapp-egfydygfdmavfxg9.westus-01.azurewebsites.net";

  // Parcel: GET /api/parcels/{parcel}?code=...
  const PARCEL_URL = (v) =>
    `${BASE}/api/parcels/${encodeURIComponent(v)}?code=HvcyDqdJg3iCJT-xt4AZ0wtGvJALITMb8JFCwiIYFOmtAzFul9CJrA==`;

  // Bill: GET /api/bills/{bill}?code=...
  const BILL_URL = (v) =>
    `${BASE}/api/bills/${encodeURIComponent(v)}?code=PE97g8PBfTUnpfFBOGi1rlHrW2Ht9alomPv0D7Ub08vWAzFuA0XlPA==`;

  const $ = (id) => document.getElementById(id);
  function say(t, cls=""){ const e=$("m"); e.className="msg "+cls; e.textContent=t; }
  function setVal(v){
    if (window.JFCustomWidget && typeof JFCustomWidget.setValue === "function") {
      JFCustomWidget.setValue(v); // e.g., "parcel|3132201260000" or "bill|20190586370"; "" if invalid
    }
  }
  const debounce=(fn,ms)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms);} };
  async function getJson(url){
    const res = await fetch(url, { method:"GET", mode:"cors", cache:"no-store" });
    let data=null; try{ data=await res.json(); }catch{}
    return { status:res.status, ok:res.ok, data };
  }

  async function validateRaw(raw){
    const v = (raw||"").replace(/[^\d]/g,"").trim(); // digits only
    if(!v){ setVal(""); say("Enter a parcel or bill number."); return; }
    say("Validating…");
    try{
      // 1) Try parcel
      let r = await getJson(PARCEL_URL(v));
      if (r.ok && (r.data?.exists===true || r.data?.ok===true)){
        const n = r.data.normalized || r.data.parcel || v;
        setVal(`parcel|${n}`); say("✓ Valid parcel","ok"); return;
      }
      // 2) Try bill
      r = await getJson(BILL_URL(v));
      if (r.ok && (r.data?.exists===true || r.data?.ok===true)){
        const n = r.data.normalized || r.data.bill || v;
        setVal(`bill|${n}`); say("✓ Valid bill","ok"); return;
      }
      setVal(""); say("✗ Invalid number","bad");
    }catch{
      setVal(""); say("⚠ Error contacting validator","bad");
    }
  }

  const validate = debounce(validateRaw, 250);
  (function init(){
    if(window.JFCustomWidget && typeof JFCustomWidget.subscribe==="function"){
      JFCustomWidget.subscribe("ready", ()=>setVal(""));
      JFCustomWidget.subscribe("submit", ()=>JFCustomWidget.sendSubmit(true));
    }
    $("num").addEventListener("input",  e=>validate(e.target.value));
    $("num").addEventListener("change", e=>validate(e.target.value));
    $("num").addEventListener("blur",   e=>validate(e.target.value));
  })();
</script>
