<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>TaxSys Validator (Parcel/Bill/Message)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            color-scheme: light dark;
        }

        body {
            font: 14px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
            margin: 0;
            padding: 10px;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .field {
            display: block;
        }

        label {
            display: block;
            margin: 0 0 6px;
            font-weight: 600;
        }

        input, textarea {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 8px;
        }

        textarea {
            min-height: 96px;
            resize: vertical;
        }

        .msg {
            margin-top: 6px;
            min-height: 1.1rem;
            font-size: 12px;
        }

        .ok {
            color: #156c1e;
        }

        .bad {
            color: #9f1d1d;
        }

        .hint {
            opacity: .8;
            font-size: 12px;
            margin-top: 8px;
        }

        .hidden {
            display: none !important;
        }

        .substatus {
            font-size: 12px;
            opacity: .9;
            margin-top: 6px;
        }
    </style>
    <script src="https://js.jotform.com/JotFormCustomWidget.min.js"></script>
</head>
<body>
    <!-- Parcel/Bill UI (for parcel/bill/both variants) -->
    <div id="pbWrap" class="row">
        <div class="field" id="parcelField">
            <label for="parcel" id="label_parcel">Parcel Number</label>
            <input id="parcel" placeholder="Enter parcel number" autocomplete="off" inputmode="numeric" />
            <div id="m_parcel" class="msg">We’ll verify this before you submit.</div>
        </div>
        <div class="field" id="billField">
            <label for="bill" id="label_bill">Bill Number</label>
            <input id="bill" placeholder="Enter bill number" autocomplete="off" inputmode="numeric" />
            <div id="m_bill" class="msg">We’ll verify this before you submit.</div>
        </div>
    </div>

    <!-- Smart message variant -->
    <div id="msgWrap" class="field hidden">
        <label for="freeText" id="label_message">Enter your message in the space provided below</label>
        <textarea id="freeText" placeholder="Type here… e.g. please check parcel 3132201260000 and bill 20150806261"></textarea>
        <div id="m_message" class="msg">We’ll auto-detect parcel/bill numbers and validate them.</div>
        <div class="substatus" id="m_msg_parcel"></div>
        <div class="substatus" id="m_msg_bill"></div>
    </div>

    <div id="standaloneHint" class="hint" style="display:none">(Opened outside Jotform.)</div>

    <script>
    // ======== CONFIG (edit if your Unique Names differ) ========
    const UNIQUE_PARCEL = "typeA32"; // native Short Text unique name
    const UNIQUE_BILL   = "billNumber";   // native Short Text unique name

    // Strict lengths (adjust to your real formats)
    const PARCEL_LEN = 13;
    const BILL_LEN   = 11;

    // ======== ENDPOINTS ========
    const BASE = "https://zendeskfunctionapp-egfydygfdmavfxg9.westus-01.azurewebsites.net";
    const PARCEL_URL = (v) => `${BASE}/api/public/parcels/${encodeURIComponent(v)}`;
    const BILL_URL   = (v) => `${BASE}/api/public/bills/${encodeURIComponent(v)}`;

    // ======== UTILS ========
    const $ = (id) => document.getElementById(id);
    const onlyDigits = (s) => (s || "").replace(/[^\d]/g, "").trim();
    const debounce = (fn, ms) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; };
    const safeDecode = (v)=>{ if(!v) return v; try{ v=decodeURIComponent(v);}catch{} try{ v=decodeURIComponent(v);}catch{} return v.replace(/\+/g,' '); };
    const say = (id, txt, cls="") => { const e=$(id); if(!e) return; e.className = "msg "+(cls||""); e.textContent = txt; };
    const sayLine = (id, txt, cls="") => { const e=$(id); if(!e) return; e.className = "substatus "+(cls||""); e.textContent = txt; };
    async function getJson(url){ const res=await fetch(url,{method:"GET",mode:"cors",cache:"no-store"}); let data=null; try{data=await res.json();}catch{} return {ok:res.ok,status:res.status,data}; }

    // Strict extractors
    function extractFirstParcel(s){
      const m = s.match(new RegExp(`\\b\\d{${PARCEL_LEN}}\\b`, 'g')) || [];
      return (m[0] || "").replace(/[^\d]/g, "");
    }
    function extractFirstBill(s){
      const m = s.match(new RegExp(`\\b\\d{${BILL_LEN}}\\b`, 'g')) || [];
      return (m[0] || "").replace(/[^\d]/g, "");
    }

    // Mirror into native fields
    function populateFormField(uniqueName, value) {
      try {
        window.parent.postMessage({ action: "populate", field: uniqueName, value: value || "" }, "*");
      } catch {}
    }

    // ======== QUERY PARAMS ========
    const params      = new URLSearchParams(location.search);
    const variant     = (params.get("variant") || "both").toLowerCase();   // parcel | bill | both | message
    const requireMode = (params.get("require") || "any").toLowerCase();    // any | both | parcel | bill | none
    const labelOverrides = {
      parcelLabel: safeDecode(params.get("parcelLabel")),
      billLabel:   safeDecode(params.get("billLabel")),
      parcelPh:    safeDecode(params.get("parcelPh")),
      billPh:      safeDecode(params.get("billPh")),
      messageLabel:safeDecode(params.get("messageLabel")),
      messagePh:   safeDecode(params.get("messagePh")),
    };

    // ======== STATE ========
    const state = { parcel:"", bill:"", parcelOk:false, billOk:false, message:"" };

    // De-dupe + candidate tracking (so we keep status until number changes)
    let lastCheckedParcel = null;
    let lastCheckedBill   = null;
    let prevParcelCandidate = null;
    let prevBillCandidate   = null;

    // ======== JF SIGNALS (modern + legacy) ========
    function sendLive(valueStr){
      if(!window.JFCustomWidget) return;
      try { JFCustomWidget.setValue(valueStr); } catch {}
      try { JFCustomWidget.sendData({ valid: true, value: valueStr }); } catch {}
      try { JFCustomWidget.setHeight(document.body.scrollHeight || 180); } catch {}
    }
    function sendSubmitValue(valueStr){
      if(!window.JFCustomWidget) return;
      try { JFCustomWidget.sendSubmit({ valid: true, value: valueStr }); return; } catch {}
      try { JFCustomWidget.sendSubmit(true); } catch {}
    }
    function currentString(){
      if (variant === "parcel")   return state.parcel || "";
      if (variant === "bill")     return state.bill   || "";
      if (variant === "message")  return JSON.stringify({ message: state.message, parcel: state.parcel, bill: state.bill });
      return JSON.stringify({ ...state, variant, requireMode }); // both
    }

    // ======== UI TOGGLING ========
    function applyVariantUI(){
      const pb = $("pbWrap"), msg = $("msgWrap");
      if (variant === "message"){
        pb?.classList.add("hidden");
        msg?.classList.remove("hidden");
      } else {
        msg?.classList.add("hidden");
        pb?.classList.remove("hidden");
        if (variant === "parcel") $("billField")?.classList.add("hidden");
        if (variant === "bill")   $("parcelField")?.classList.add("hidden");
      }
    }

    // ======== VALIDATORS ========
    async function validateParcel(raw, {alsoMsg=false} = {}){
      const val = onlyDigits(raw);

      if(!val){
        state.parcel=""; state.parcelOk=false;
        sendLive(currentString());
        say("m_parcel","Enter a parcel number or leave blank if none.");
        if (alsoMsg) sayLine("m_msg_parcel","No parcel detected.","");
        return;
      }

      // de-dupe: only if same as last checked AND candidate hasn't changed
      if (val === lastCheckedParcel && prevParcelCandidate === val) return;
      lastCheckedParcel = val;

      say("m_parcel","Validating parcel…");
      if (alsoMsg) sayLine("m_msg_parcel","Validating parcel…","");
      try{
        const r = await getJson(PARCEL_URL(val));
        if(r.ok && (r.data?.exists===true || r.data?.ok===true)){
          state.parcel = r.data.normalized || r.data.parcel || val;
          state.parcelOk = true;
          populateFormField(UNIQUE_PARCEL, state.parcel);
          sendLive(currentString());
          say("m_parcel","✓ Valid parcel","ok");
          if (alsoMsg) sayLine("m_msg_parcel",`✓ Parcel ${state.parcel} is valid`,"ok");
        } else {
          state.parcel=""; state.parcelOk=false;
          populateFormField(UNIQUE_PARCEL,"");
          sendLive(currentString());
          say("m_parcel","✗ Invalid parcel number. Please check and retype again","bad");
          if (alsoMsg) sayLine("m_msg_parcel","✗ Parcel is invalid","bad");
        }
      }catch{
        state.parcel=""; state.parcelOk=false;
        sendLive(currentString());
        say("m_parcel","⚠ Error contacting parcel validator.","bad");
        if (alsoMsg) sayLine("m_msg_parcel","⚠ Error contacting parcel validator","bad");
      }
    }

    async function validateBill(raw, {alsoMsg=false} = {}){
      const val = onlyDigits(raw);

      if(!val){
        state.bill=""; state.billOk=false;
        sendLive(currentString());
        say("m_bill","Enter a bill number or leave blank if none.");
        if (alsoMsg) sayLine("m_msg_bill","No bill detected.","");
        return;
      }

      if (val === lastCheckedBill && prevBillCandidate === val) return;
      lastCheckedBill = val;

      say("m_bill","Validating bill…");
      if (alsoMsg) sayLine("m_msg_bill","Validating bill…","");
      try{
        const r = await getJson(BILL_URL(val));
        if(r.ok && (r.data?.exists===true || r.data?.ok===true)){
          state.bill = r.data.normalized || r.data.bill || val;
          state.billOk = true;
          populateFormField(UNIQUE_BILL, state.bill);
          sendLive(currentString());
          say("m_bill","✓ Valid bill","ok");
          if (alsoMsg) sayLine("m_msg_bill",`✓ Bill ${state.bill} is valid`,"ok");
        } else {
          state.bill=""; state.billOk=false;
          populateFormField(UNIQUE_BILL,"");
          sendLive(currentString());
          say("m_bill","✗ Invalid bill number. Please check and retype again","bad");
          if (alsoMsg) sayLine("m_msg_bill","✗ Bill is invalid","bad");
        }
      }catch{
        state.bill=""; state.billOk=false;
        sendLive(currentString());
        say("m_bill","⚠ Error contacting bill validator.","bad");
        if (alsoMsg) sayLine("m_msg_bill","⚠ Error contacting bill validator","bad");
      }
    }

    const debouncedParcel = debounce((v)=>validateParcel(v, {alsoMsg: variant==="message"}), 250);
    const debouncedBill   = debounce((v)=>validateBill(v,   {alsoMsg: variant==="message"}), 250);

    // ======== MESSAGE VARIANT HANDLER ========
    function onMessageInput(rawText){
      state.message = rawText || "";

      // strict extraction
      let candParcel = extractFirstParcel(rawText);
      let candBill   = extractFirstBill(rawText);

      // (lengths are distinct; keep a safeguard anyway)
      if (candParcel && candBill && candParcel === candBill) {
        if (candParcel.length === PARCEL_LEN && candBill.length !== BILL_LEN) candBill = "";
        else if (candBill.length === BILL_LEN && candParcel.length !== PARCEL_LEN) candParcel = "";
        else candBill = "";
      }

      // If candidate CHANGED, show "Validating…" (otherwise keep last ✓/✗)
      if (candParcel !== prevParcelCandidate) {
        if (candParcel) sayLine("m_msg_parcel","Validating parcel…","");
        else            sayLine("m_msg_parcel","No parcel detected.","");
        lastCheckedParcel = null;             // allow re-validate
      }
      if (candBill !== prevBillCandidate) {
        if (candBill)   sayLine("m_msg_bill","Validating bill…","");
        else            sayLine("m_msg_bill","No bill detected.","");
        lastCheckedBill = null;
      }
      prevParcelCandidate = candParcel || null;
      prevBillCandidate   = candBill   || null;

      // mirror immediately
      state.parcel = candParcel || "";
      state.bill   = candBill   || "";
      populateFormField(UNIQUE_PARCEL, state.parcel);
      populateFormField(UNIQUE_BILL,   state.bill);

      // push live value
      sendLive(currentString());

      // debounced validation → hits correct endpoints
      if (state.parcel) debouncedParcel(state.parcel);
      if (state.bill)   debouncedBill(state.bill);
    }

    // ======== BOOTSTRAP ========
    (function init(){
      applyVariantUI();

      // Labels/placeholders
      if (labelOverrides.parcelLabel){ const l=$("label_parcel"); if(l) l.textContent=labelOverrides.parcelLabel; }
      if (labelOverrides.billLabel){   const l=$("label_bill");   if(l) l.textContent=labelOverrides.billLabel; }
      if (labelOverrides.messageLabel){ const l=$("label_message"); if(l) l.textContent=labelOverrides.messageLabel; }
      if (labelOverrides.parcelPh && $("parcel")) $("parcel").placeholder = labelOverrides.parcelPh;
      if (labelOverrides.billPh   && $("bill"))   $("bill").placeholder   = labelOverrides.billPh;
      if (labelOverrides.messagePh&& $("freeText")) $("freeText").placeholder = labelOverrides.messagePh;

      // Listeners
      const onParcelInput=(e)=>{ if(e?.target?.id!=="parcel") return; state.parcel=onlyDigits(e.target.value); sendLive(currentString()); debouncedParcel(e.target.value); };
      const onBillInput  =(e)=>{ if(e?.target?.id!=="bill")   return; state.bill  =onlyDigits(e.target.value); sendLive(currentString()); debouncedBill(e.target.value); };
      const onMsgInput   =(e)=>{ if(e?.target?.id!=="freeText") return; onMessageInput(e.target.value); };

      document.addEventListener("input",  onParcelInput, true);
      document.addEventListener("change", onParcelInput, true);
      document.addEventListener("input",  onBillInput,   true);
      document.addEventListener("change", onBillInput,   true);
      document.addEventListener("input",  onMsgInput,    true);
      document.addEventListener("change", onMsgInput,    true);

      // Jotform lifecycle
      if (window.JFCustomWidget && typeof JFCustomWidget.subscribe === "function"){
        JFCustomWidget.subscribe("ready", () => {
          state.parcel=""; state.bill=""; state.parcelOk=false; state.billOk=false; state.message="";
          sendLive(currentString());
        });
        JFCustomWidget.subscribe("submit", () => {
          if ($("freeText")) state.message = $("freeText").value || "";
          if ($("parcel"))   state.parcel  = onlyDigits($("parcel").value);
          if ($("bill"))     state.bill    = onlyDigits($("bill").value);
          sendSubmitValue(currentString());
        });
      } else {
        const showHint=()=>{ const hint=$("standaloneHint"); if(hint) hint.style.display="block"; };
        if(document.readyState==="loading") document.addEventListener("DOMContentLoaded", showHint, {once:true}); else showHint();
      }
    })();
    </script>
</body>
</html>
