<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Parcel + Bill Validator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            color-scheme: light dark;
        }

        body {
            font: 14px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
            margin: 0;
            padding: 10px;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .field {
            display: block;
        }

        label {
            display: block;
            margin: 0 0 6px;
            font-weight: 600;
        }

        input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 8px;
        }

        .msg {
            margin-top: 6px;
            min-height: 1.1rem;
            font-size: 12px;
        }

        .ok {
            color: #156c1e;
        }

        .bad {
            color: #9f1d1d;
        }

        .hint {
            opacity: .8;
            font-size: 12px;
            margin-top: 8px;
        }
    </style>
    <script src="https://js.jotform.com/JotFormCustomWidget.min.js"></script>
</head>
<body>
    <div class="row">
        <div class="field">
            <label for="parcel">Parcel Number</label>
            <!-- allow letters: use text, not numeric -->
            <input id="parcel" placeholder="Enter parcel number" autocomplete="off" inputmode="text" />
            <div id="m_parcel" class="msg">We’ll verify this before you submit.</div>
        </div>
        <div class="field">
            <label for="bill">Bill Number</label>
            <input id="bill" placeholder="Enter bill number" autocomplete="off" inputmode="numeric" />
            <div id="m_bill" class="msg">We’ll verify this before you submit.</div>
        </div>
    </div>

    <div id="standaloneHint" class="hint" style="display:none">(Opened outside Jotform.)</div>

    <script>
  // ===== LIVE ENDPOINTS (unchanged) =====
  const BASE = "https://zendeskfunctionapp-egfydygfdmavfxg9.westus-01.azurewebsites.net";
  const PARCEL_URL = (v) => `${BASE}/api/public/parcels/${encodeURIComponent(v)}`;
  const BILL_URL   = (v) => `${BASE}/api/public/bills/${encodeURIComponent(v)}`;

  // ===== Utilities =====
  const $ = (id) => document.getElementById(id);
  const onlyDigits = (s) => String(s || "").replace(/\D/g, "").trim();
  const onlyAlnum  = (s) => String(s || "").replace(/[^A-Za-z0-9]/g, "").trim();
  const isParcelFormat = (s) => /^[A-Za-z0-9]{13}$/.test(s);                    // 13 alnum
  const isBillFormat   = (s) => /^\d{9}$/.test(s) || /^\d{11}$/.test(s);        // 9 or 11 digits
  const debounce = (fn, ms) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; };

  function say(whereId, text, cls = "") {
    const e = $(whereId);
    if (!e) return;
    e.className = "msg " + cls;
    e.textContent = text;
  }

  // Abort controllers to cancel stale requests while typing
  const inflight = { parcel: null, bill: null };
  async function getJson(url, kind) {
    if (inflight[kind]) inflight[kind].abort();
    const ctrl = new AbortController();
    inflight[kind] = ctrl;
    try {
      const res = await fetch(url, { method: "GET", cache: "no-store", signal: ctrl.signal });
      let data = null; try { data = await res.json(); } catch {}
      return { status: res.status, ok: res.ok, data };
    } finally {
      if (inflight[kind] === ctrl) inflight[kind] = null;
    }
  }

  // ===== State we send back to Jotform =====
  const state = {
    parcel: "",     // normalized value or ""
    bill: "",       // normalized value or ""
    parcelOk: false,
    billOk: false,
    message: ""     // cleaned message without extracted numbers
  };

  function pushToJotform() {
    if (window.JFCustomWidget && typeof JFCustomWidget.setValue === "function") {
      JFCustomWidget.setValue(JSON.stringify(state));
    }
  }

  // ===== Validators (independent) =====
  async function validateParcel(raw) {
    const val = onlyAlnum(raw);
    if (!val) {
      state.parcel = ""; state.parcelOk = false; pushToJotform();
      say("m_parcel", "Enter a 13-character parcel/account number or leave blank if none.");
      return;
    }
    if (!isParcelFormat(val)) {
      state.parcel = ""; state.parcelOk = false; pushToJotform();
      say("m_parcel", "That doesn’t look like a parcel number (13 letters/numbers).", "bad");
      return;
    }
    say("m_parcel", "Validating parcel…");
    try {
      const r = await getJson(PARCEL_URL(val), "parcel");
      if (r.ok && (r.data?.exists === true || r.data?.ok === true)) {
        const n = r.data.normalized || r.data.parcel || val;
        state.parcel = n; state.parcelOk = true; pushToJotform();
        say("m_parcel", "✓ Valid parcel", "ok");
      } else if (r.status === 404) {
        state.parcel = ""; state.parcelOk = false; pushToJotform();
        say("m_parcel", "✗ Invalid parcel number. Please verify and try again.", "bad");
      } else {
        state.parcel = ""; state.parcelOk = false; pushToJotform();
        say("m_parcel", "Parcel check failed. Please try again later.", "bad");
      }
    } catch (e) {
      if (e.name === "AbortError") return;
      state.parcel = ""; state.parcelOk = false; pushToJotform();
      say("m_parcel", "⚠ Error contacting parcel validator.", "bad");
    }
  }

  async function validateBill(raw) {
    const val = onlyDigits(raw);
    if (!val) {
      state.bill = ""; state.billOk = false; pushToJotform();
      say("m_bill", "Enter a 9 or 11-digit bill number or leave blank if none.");
      return;
    }
    if (!isBillFormat(val)) {
      state.bill = ""; state.billOk = false; pushToJotform();
      say("m_bill", "That doesn’t look like a bill number (9 or 11 digits).", "bad");
      return;
    }
    say("m_bill", "Validating bill…");
    try {
      const r = await getJson(BILL_URL(val), "bill");
      if (r.ok && (r.data?.exists === true || r.data?.ok === true)) {
        const n = r.data.normalized || r.data.bill || val;
        state.bill = n; state.billOk = true; pushToJotform();
        say("m_bill", "✓ Valid bill", "ok");
      } else if (r.status === 404) {
        state.bill = ""; state.billOk = false; pushToJotform();
        say("m_bill", "✗ Invalid bill number. Please verify and try again.", "bad");
      } else {
        state.bill = ""; state.billOk = false; pushToJotform();
        say("m_bill", "Bill check failed. Please try again later.", "bad");
      }
    } catch (e) {
      if (e.name === "AbortError") return;
      state.bill = ""; state.billOk = false; pushToJotform();
      say("m_bill", "⚠ Error contacting bill validator.", "bad");
    }
  }

  const debouncedParcel = debounce((v) => validateParcel(v), 250);
  const debouncedBill   = debounce((v) => validateBill(v), 250);

  // ===== Free-text parser (from the Jotform Message field) =====

  // Find parcel: allow 13 alnum with optional spaces/dashes between chars
  function findParcel(text) {
    const s = String(text || "");
    const re = /(?:[A-Za-z0-9][-\s]?){13}/g;
    let m; const hits = [];
    while ((m = re.exec(s)) !== null) {
      const normalized = m[0].replace(/[^A-Za-z0-9]/g, "");
      if (normalized.length === 13) hits.push(normalized);
    }
    return hits[0] || ""; // change to hits.at(-1) to pick last
  }

  // Find bill: 11 first (more specific), then 9 digits; separators allowed
  function findBill(text) {
    const s = String(text || "");
    const re11 = /(?:\d[-\s]?){11}(?!\d)/g;
    const re9  = /(?:\d[-\s]?){9}(?!\d)/g;
    let m; const hits = [];
    while ((m = re11.exec(s)) !== null) hits.push(m[0].replace(/\D/g, ""));
    while ((m = re9.exec(s))  !== null) hits.push(m[0].replace(/\D/g, ""));
    return hits[0] || "";
  }

  function extractFromMessage(text) {
    const parcelCandidate = findParcel(text);
    const billCandidate   = findBill(text);

    let cleaned = String(text || "");
    if (parcelCandidate) {
      const parcelSep = parcelCandidate.split("").join("[-\\s]?");
      cleaned = cleaned.replace(new RegExp(parcelSep, "i"), "").trim();
    }
    if (billCandidate) {
      const billSep = billCandidate.split("").join("[-\\s]?");
      cleaned = cleaned.replace(new RegExp(billSep, "i"), "").trim();
    }
    return { parcelCandidate, billCandidate, cleanedMessage: cleaned };
  }

  const handleMessageDebounced = debounce(async (text) => {
    const { parcelCandidate, billCandidate, cleanedMessage } = extractFromMessage(text);

    const parcelEl = $("parcel");
    const billEl   = $("bill");
    let touched = false;

    if (parcelCandidate) {
      if (parcelEl) parcelEl.value = parcelCandidate;
      await validateParcel(parcelCandidate);
      touched = true;
    }
    if (billCandidate) {
      if (billEl) billEl.value = billCandidate;
      await validateBill(billCandidate);
      touched = true;
    }

    state.message = cleanedMessage;
    pushToJotform();

    if (!touched && !state.parcel && !state.bill) {
      say("m_parcel", "Enter a parcel number or leave blank if none.");
      say("m_bill",   "Enter a bill number or leave blank if none.");
    }
  }, 250);

  // ===== Wiring =====
  (function bootstrap() {
    if (window.__taxSysValidatorTwoBoxInit) return;
    window.__taxSysValidatorTwoBoxInit = true;

    const parcelEl = $("parcel");
    const billEl   = $("bill");

    // Jotform lifecycle
    if (window.JFCustomWidget && typeof JFCustomWidget.subscribe === "function") {
      JFCustomWidget.subscribe("ready",  () => {
        // optional: control height to avoid scrollbars
        if (window.JFCustomWidget.setHeight) JFCustomWidget.setHeight(170);
        state.parcel=""; state.bill=""; state.parcelOk=false; state.billOk=false; state.message="";
        pushToJotform();
      });

      // Receive Message text via Jotform condition (Message -> Widget)
      JFCustomWidget.subscribe("populate", (msg) => {
        const text = (msg && (msg.value ?? msg.text ?? msg.data ?? msg.content)) || "";
        handleMessageDebounced(text);
      });

      // Submit: allow if at least one is valid OR both blank; return full JSON value
      JFCustomWidget.subscribe("submit", () => {
        const allow = (state.parcelOk || state.billOk) || (!state.parcel && !state.bill);
        const payload = JSON.stringify(state);
        JFCustomWidget.sendSubmit({ valid: !!allow, value: payload });
      });
    } else {
      const showHint = () => { const hint = $("standaloneHint"); if (hint) hint.style.display = "block"; };
      if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", showHint, { once: true });
      else showHint();
    }

    // Attach listeners directly to inputs
    parcelEl?.addEventListener("input", (e) => debouncedParcel(e.target.value));
    parcelEl?.addEventListener("change", (e) => validateParcel(e.target.value));
    billEl  ?.addEventListener("input", (e) => debouncedBill(e.target.value));
    billEl  ?.addEventListener("change", (e) => validateBill(e.target.value));

    // Prefill/initial run
    const runInitial = () => {
      if (parcelEl?.value) debouncedParcel(parcelEl.value);
      if (billEl  ?.value) debouncedBill(billEl.value);
      pushToJotform();
    };
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", () => { queueMicrotask(runInitial); }, { once: true });
    } else {
      queueMicrotask(runInitial);
    }
  })();
    </script>
</body>
</html>
