<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>TaxSys Validator (Parcel/Bill/Message)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            color-scheme: light dark;
        }

        body {
            font: 14px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
            margin: 0;
            padding: 10px;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .field {
            display: block;
        }

        label {
            display: block;
            margin: 0 0 6px;
            font-weight: 400;
        }
        /* no bold */
        input, textarea {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 8px;
        }

        textarea {
            min-height: 96px;
            resize: vertical;
        }

        .msg {
            margin-top: 6px;
            min-height: 1.1rem;
            font-size: 12px;
        }

        .ok {
            color: #156c1e;
        }

        .bad {
            color: #9f1d1d;
        }

        .hint {
            opacity: .8;
            font-size: 12px;
            margin-top: 8px;
        }

        .hidden {
            display: none !important;
        }

        .substatus {
            font-size: 12px;
            opacity: .9;
            margin-top: 6px;
        }
    </style>
    <script src="https://js.jotform.com/JotFormCustomWidget.min.js"></script>
</head>
<body>
    <!-- Parcel/Bill UI (hidden when variant=message) -->
    <div id="pbWrap" class="row">
        <div class="field" id="parcelField">
            <label for="parcel" id="label_parcel">Parcel Number (Optional)</label>
            <input id="parcel" placeholder="Enter parcel number" autocomplete="off" inputmode="text" />
            <div id="m_parcel" class="msg">We’ll verify this before you submit.</div>
        </div>
        <div class="field" id="billField">
            <label for="bill" id="label_bill">Bill Number (Optional)</label>
            <input id="bill" placeholder="Enter bill number" autocomplete="off" inputmode="text" />
            <div id="m_bill" class="msg">We’ll verify this before you submit.</div>
        </div>
    </div>

    <!-- Message variant -->
    <div id="msgWrap" class="field hidden">
        <label for="freeText" id="label_message">Enter your message in the space provided below:</label>
        <textarea id="freeText" placeholder=""></textarea>
        <div id="m_message" class="msg">We’ll auto-detect parcel/bill numbers and validate them.</div>
        <div class="substatus" id="m_msg_parcel">No parcel detected.</div>
        <div class="substatus" id="m_msg_bill">No bill detected.</div>
    </div>

    <div id="standaloneHint" class="hint" style="display:none">(Opened outside Jotform.)</div>

    <script>
    // ======== YOUR JOTFORM FIELD UNIQUE NAMES ========
    const UNIQUE_MESSAGE_COPY  = "typeA86";   // gets formatted "PARCEL13|BILL11"
    const UNIQUE_ENTER_MESSAGE = "enterYour"; // gets the full raw text (Zendesk-mapped)

    // (Optional: set to "" if you don't need these mirrored)
    const UNIQUE_PARCEL = ""; // e.g., "parcelNumber"
    const UNIQUE_BILL   = ""; // e.g., "billNumber"

    // ======== RULES ========
    const PARCEL_LEN = 13;             // parcel length (alphanumeric)
    const BILL_LENS  = [9, 11];        // bill can be 9 or 11 (digits only)

    // ======== ENDPOINTS ========
    let BASE = "https://zendeskfunctionapp-egfydygfdmavfxg9.westus-01.azurewebsites.net";
    let PARCEL_URL = (v) => `${BASE}/api/public/parcels/${encodeURIComponent(v)}`;
    let BILL_URL   = (v) => `${BASE}/api/public/bills/${encodeURIComponent(v)}`;

    // ======== UTILS ========
    const $ = (id) => document.getElementById(id);
    const debounce = (fn, ms=250) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };
    const safeDecode = (v)=>{ if(!v) return v; try{ v=decodeURIComponent(v);}catch{} try{ v=decodeURIComponent(v);}catch{} return v.replace(/\+/g,' '); };
    const normalizeParcel = (s) => (s || "").replace(/[^0-9a-z]/gi, "").toUpperCase();
    const normalizeBill   = (s) => (s || "").replace(/[^0-9]/g, ""); // DIGITS ONLY

    function requestResize() {
      try {
        const h = Math.max(document.body.scrollHeight, 180);
        if (window.JFCustomWidget?.requestFrameResize) JFCustomWidget.requestFrameResize({ height: h });
        else if (window.JFCustomWidget?.setHeight)     JFCustomWidget.setHeight(h);
      } catch {}
    }
    const say = (id, txt, cls="") => { const e=$(id); if(!e) return; e.className = "msg "+(cls||""); e.textContent = txt || ""; requestResize(); };
    const sayLine = (id, txt, cls="") => { const e=$(id); if(!e) return; e.className = "substatus "+(cls||""); e.textContent = txt || ""; requestResize(); };

    async function getJson(url){
      const res = await fetch(url, { method:"GET", mode:"cors", cache:"no-store" });
      let data=null; try{ data=await res.json(); }catch{}
      return { ok: res.ok, status: res.status, data };
    }

    // ======== Extractors (scan entire string) ========
    function extractFirstParcel(s){
      const m = (s || "").match(new RegExp(`\\b[0-9A-Za-z]{${PARCEL_LEN}}\\b`, 'g')) || [];
      return normalizeParcel(m[0] || "");
    }
    function extractFirstBill(s){
      // DIGITS ONLY so words like "INFORMATION" won't match
      const str = (s || "");
      const m = str.match(/\b(?:\d{11}|\d{9})\b/g);
      return normalizeBill(m && m.length ? m[0] : "");
    }
    const looksLikeBillLen = (v) => BILL_LENS.includes((v||"").length);

    // ======== QUERY PARAMS (controls UI and labels) ========
    const params      = new URLSearchParams(location.search);
    const variant     = (params.get("variant") || "both").toLowerCase();   // parcel | bill | both | message
    const requireMode = (params.get("require") || "any").toLowerCase();    // any | both | parcel | bill | none

    const labelOverrides = {
      parcelLabel: safeDecode(params.get("parcelLabel")),
      billLabel:   safeDecode(params.get("billLabel")),
      parcelPh:    safeDecode(params.get("parcelPh")),
      billPh:      safeDecode(params.get("billPh")),
      messageLabel:safeDecode(params.get("messageLabel")),
      messagePh:   safeDecode(params.get("messagePh")),
    };

    // Optional endpoint overrides via URL (?parcelsEndpoint=&billsEndpoint=&base=)
    const urlParcels = safeDecode(params.get("parcelsEndpoint"));
    const urlBills   = safeDecode(params.get("billsEndpoint"));
    const urlBase    = safeDecode(params.get("base"));
    if (urlBase)   BASE = urlBase;
    if (urlParcels) PARCEL_URL = (v) => `${urlParcels.replace(/\/$/,'')}/${encodeURIComponent(v)}`;
    if (urlBills)   BILL_URL   = (v) => `${urlBills.replace(/\/$/,'')}/${encodeURIComponent(v)}`;

    // ======== STATE ========
    const state = { parcel:"", bill:"", parcelOk:false, billOk:false, message:"" };
    let lastCheckedParcel = null, lastCheckedBill = null;
    let prevParcelCandidate = null, prevBillCandidate = null;

    // ======== ENCODER (fixed widths) ========
    function fixedEncode(p, b) {
      const P = normalizeParcel(p);
      const B = normalizeBill(b);
      const p13 = (("0000000000000" + P).slice(-13)).slice(0,13);
      const b11 = (("00000000000"  + B).slice(-11)).slice(0,11);
      return `${p13}|${b11}`;
    }

    // ======== Bridge helpers ========
    function setFieldsValue(map){
      if (window.JFCustomWidget?.setFieldsValue) {
        try { JFCustomWidget.setFieldsValue(map); return; } catch {}
      }
      // Fallback (best-effort)
      try { for (const [field, value] of Object.entries(map)) {
        parent.postMessage({ action:"populate", field, value: value ?? "" }, "*");
      }} catch {}
    }

    function syncToForm() {
      if (UNIQUE_PARCEL) setFieldsValue({ [UNIQUE_PARCEL]: state.parcel || "" });
      if (UNIQUE_BILL)   setFieldsValue({ [UNIQUE_BILL]:   state.bill   || "" });
      if (UNIQUE_MESSAGE_COPY)  setFieldsValue({ [UNIQUE_MESSAGE_COPY]:  fixedEncode(state.parcel, state.bill) });
      if (UNIQUE_ENTER_MESSAGE && variant === "message") setFieldsValue({ [UNIQUE_ENTER_MESSAGE]: state.message || "" });
    }

    function emitWidgetValue(){
      const valueForWidget = (variant === "message")
        ? (state.message || "")
        : fixedEncode(state.parcel, state.bill);

      if (window.JFCustomWidget) {
        try { JFCustomWidget.setValue(valueForWidget); } catch {}
        try { JFCustomWidget.sendData({ valid:true, value:valueForWidget }); } catch {}
      }
      syncToForm();
      requestResize();
    }

    const currentSubmitValue = () => (variant === "message" ? (state.message || "") : fixedEncode(state.parcel, state.bill));

    function applyVariantUI(){
      const pb = $("pbWrap"), msg = $("msgWrap");
      if (variant === "message"){ pb?.classList.add("hidden"); msg?.classList.remove("hidden"); }
      else {
        msg?.classList.add("hidden"); pb?.classList.remove("hidden");
        if (variant === "parcel") $("billField")?.classList.add("hidden");
        if (variant === "bill")   $("parcelField")?.classList.add("hidden");
      }
      requestResize();
    }

    // ======== Validators ========
    async function validateParcel(raw, {alsoMsg=false} = {}){
      const val = normalizeParcel(raw);
      if(!val){ state.parcel=""; state.parcelOk=false; emitWidgetValue();
        say("m_parcel","Enter a parcel number or leave blank if none.");
        if (alsoMsg) sayLine("m_msg_parcel","No parcel detected.",""); return; }
      if (val.length !== PARCEL_LEN){ state.parcel=""; state.parcelOk=false; emitWidgetValue();
        say("m_parcel",`Parcel must be ${PARCEL_LEN} characters.`,"bad");
        if (alsoMsg) sayLine("m_msg_parcel",`Parcel must be ${PARCEL_LEN} characters.`,"bad"); return; }
      if (val === lastCheckedParcel && prevParcelCandidate === val) return;
      lastCheckedParcel = val;
      say("m_parcel","Validating parcel…"); if (alsoMsg) sayLine("m_msg_parcel","Validating parcel…","");
      try{
        const r = await getJson(PARCEL_URL(val));
        if(r.ok && (r.data?.exists===true || r.data?.ok===true)){
          state.parcel = normalizeParcel(r.data.normalized || r.data.parcel || val);
          state.parcelOk = true;
          emitWidgetValue(); say("m_parcel","✓ Valid parcel","ok");
          if (alsoMsg) sayLine("m_msg_parcel",`✓ Parcel ${state.parcel} is valid`,"ok");
        } else {
          state.parcel=""; state.parcelOk=false; emitWidgetValue();
          say("m_parcel","✗ Invalid parcel number. Please check and retype again","bad");
          if (alsoMsg) sayLine("m_msg_parcel","✗ Parcel is invalid","bad");
        }
      }catch{
        state.parcel=""; state.parcelOk=false; emitWidgetValue();
        say("m_parcel","⚠ Error contacting parcel validator.","bad");
        if (alsoMsg) sayLine("m_msg_parcel","⚠ Error contacting parcel validator","bad");
      }
    }

    async function validateBill(raw, {alsoMsg=false} = {}){
      const val = normalizeBill(raw);
      if(!val){ state.bill=""; state.billOk=false; emitWidgetValue();
        say("m_bill","Enter a bill number or leave blank if none.");
        if (alsoMsg) sayLine("m_msg_bill","No bill detected.",""); return; }
      if (!looksLikeBillLen(val)){ state.bill=""; state.billOk=false; emitWidgetValue();
        say("m_bill","Bill numbers are 9 or 11 digits.","bad");
        if (alsoMsg) sayLine("m_msg_bill","Bill numbers are 9 or 11 digits.","bad"); return; }
      if (val === lastCheckedBill && prevBillCandidate === val) return;
      lastCheckedBill = val;
      say("m_bill","Validating bill…"); if (alsoMsg) sayLine("m_msg_bill","Validating bill…","");
      try{
        const r = await getJson(BILL_URL(val));
        if(r.ok && (r.data?.exists===true || r.data?.ok===true)){
          state.bill = normalizeBill(r.data.normalized || r.data.bill || val);
          state.billOk = true;
          emitWidgetValue(); say("m_bill","✓ Valid bill","ok");
          if (alsoMsg) sayLine("m_msg_bill",`✓ Bill ${state.bill} is valid`,"ok");
        } else {
          state.bill=""; state.billOk=false; emitWidgetValue();
          say("m_bill","✗ Invalid bill number. Please check and retype again","bad");
          if (alsoMsg) sayLine("m_msg_bill","✗ Bill is invalid","bad");
        }
      }catch{
        state.bill=""; state.billOk=false; emitWidgetValue();
        say("m_bill","⚠ Error contacting bill validator.","bad");
        if (alsoMsg) sayLine("m_msg_bill","⚠ Error contacting bill validator","bad");
      }
    }

    const debouncedParcel = debounce((v)=>validateParcel(v, {alsoMsg: variant==="message"}), 250);
    const debouncedBill   = debounce((v)=>validateBill(v,   {alsoMsg: variant==="message"}), 250);

    // ======== MESSAGE VARIANT ========
    function onMessageInput(rawText){
      state.message = rawText || "";

      // live extract anywhere in the string
      let candParcel = extractFirstParcel(rawText);
      let candBill   = extractFirstBill(rawText);

      // If same token detected as both, prefer by rule
      if (candParcel && candBill && candParcel === candBill) {
        if (candParcel.length === PARCEL_LEN && !looksLikeBillLen(candBill)) candBill = "";
        else if (looksLikeBillLen(candBill) && candParcel.length !== PARCEL_LEN) candParcel = "";
        else candBill = "";
      }

      if (candParcel !== prevParcelCandidate) { sayLine("m_msg_parcel", candParcel ? "Validating parcel…" : "No parcel detected.", ""); lastCheckedParcel = null; }
      if (candBill   !== prevBillCandidate)   { sayLine("m_msg_bill",   candBill   ? "Validating bill…"   : "No bill detected.",   ""); lastCheckedBill   = null; }

      prevParcelCandidate = candParcel || null;
      prevBillCandidate   = candBill   || null;

      state.parcel = candParcel || "";
      state.bill   = candBill   || "";

      emitWidgetValue();           // sends raw message to widget (variant=message) + mirrors fields
      if (state.parcel) debouncedParcel(state.parcel);
      if (state.bill)   debouncedBill(state.bill);
    }

    // ======== REQUIRE RULES (optional) ========
    function passesRequireRule() {
      switch (requireMode) {
        case "none":   return true;
        case "parcel": return !!state.parcel && state.parcelOk;
        case "bill":   return !!state.bill   && state.billOk;
        case "both":   return (!!state.parcel && state.parcelOk) && (!!state.bill && state.billOk);
        case "any":
        default:
          const anyProvided = !!state.parcel || !!state.bill || (variant==="message" && !!state.message);
          const anyValid    = (state.parcel && state.parcelOk) || (state.bill && state.billOk) || (variant==="message" && !!state.message);
          return anyProvided ? anyValid : true;
      }
    }
    function explainRequireFailure() {
      if (requireMode === "parcel")      say("m_parcel", "Parcel required and must be valid.", "bad");
      else if (requireMode === "bill")   say("m_bill",   "Bill required and must be valid.", "bad");
      else if (requireMode === "both") { if (!state.parcelOk) say("m_parcel","Parcel must be valid.","bad"); if (!state.billOk) say("m_bill","Bill must be valid.","bad"); }
      else { if (state.parcel && !state.parcelOk) say("m_parcel","Parcel appears invalid.","bad"); if (state.bill && !state.billOk) say("m_bill","Bill appears invalid.","bad"); }
    }

    // ======== BOOT ========
    (function init(){
      // label/placeholder overrides
      const lo = labelOverrides;
      if (lo.parcelLabel){ const l=$("label_parcel"); if(l) l.textContent=lo.parcelLabel; }
      if (lo.billLabel){   const l=$("label_bill");   if(l) l.textContent=lo.billLabel; }
      if (lo.messageLabel){ const l=$("label_message"); if(l) l.textContent=lo.messageLabel; }
      if (lo.parcelPh && $("parcel")) $("parcel").placeholder = lo.parcelPh;
      if (lo.billPh   && $("bill"))   $("bill").placeholder   = lo.billPh;
      if (lo.messagePh&& $("freeText")) $("freeText").placeholder = lo.messagePh;

      applyVariantUI();

      // listeners
      document.addEventListener("input",  (e)=>{ if(e?.target?.id==="parcel"){ state.parcel=normalizeParcel(e.target.value); emitWidgetValue(); debouncedParcel(e.target.value); }}, true);
      document.addEventListener("change", (e)=>{ if(e?.target?.id==="parcel"){ state.parcel=normalizeParcel(e.target.value); emitWidgetValue(); debouncedParcel(e.target.value); }}, true);
      document.addEventListener("input",  (e)=>{ if(e?.target?.id==="bill"){ state.bill=normalizeBill(e.target.value); emitWidgetValue(); debouncedBill(e.target.value); }}, true);
      document.addEventListener("change", (e)=>{ if(e?.target?.id==="bill"){ state.bill=normalizeBill(e.target.value); emitWidgetValue(); debouncedBill(e.target.value); }}, true);
      document.addEventListener("input",  (e)=>{ if(e?.target?.id==="freeText"){ onMessageInput(e.target.value); }}, true);
      document.addEventListener("change", (e)=>{ if(e?.target?.id==="freeText"){ onMessageInput(e.target.value); }}, true);

      if (window.JFCustomWidget && typeof JFCustomWidget.subscribe === "function"){
        JFCustomWidget.subscribe("ready", () => {
          const sParcels = JFCustomWidget.getWidgetSetting?.("parcelsEndpoint");
          const sBills   = JFCustomWidget.getWidgetSetting?.("billsEndpoint");
          const sBase    = JFCustomWidget.getWidgetSetting?.("baseUrl");
          if (sBase) BASE = sBase;
          if (sParcels) PARCEL_URL = (v) => `${sParcels.replace(/\/$/,'')}/${encodeURIComponent(v)}`;
          if (sBills)   BILL_URL   = (v) => `${sBills.replace(/\/$/,'')}/${encodeURIComponent(v)}`;

          state.parcel=""; state.bill=""; state.parcelOk=false; state.billOk=false; state.message="";
          emitWidgetValue(); requestResize();
        });

        JFCustomWidget.subscribe("submit", async () => {
          if ($("freeText")) state.message = $("freeText").value || "";
          if ($("parcel"))   state.parcel  = normalizeParcel($("parcel").value);
          if ($("bill"))     state.bill    = normalizeBill($("bill").value);

          const needsParcelCheck = state.parcel && !state.parcelOk && state.parcel.length === PARCEL_LEN;
          const needsBillCheck   = state.bill   && !state.billOk   && looksLikeBillLen(state.bill);
          if (needsParcelCheck) await validateParcel(state.parcel);
          if (needsBillCheck)   await validateBill(state.bill);

          if (!passesRequireRule()) {
            explainRequireFailure();
            try { JFCustomWidget.sendSubmit({ valid:false, value: currentSubmitValue() }); return; } catch {}
            try { JFCustomWidget.sendSubmit(false); } catch {}
            return;
          }

          const payload = currentSubmitValue(); // raw when message variant; fixed otherwise
          try { JFCustomWidget.sendSubmit({ valid:true, value: payload }); return; } catch {}
          try { JFCustomWidget.sendSubmit(true); } catch {}
        });
      } else {
        const showHint=()=>{ const hint=$("standaloneHint"); if(hint) hint.style.display="block"; };
        if(document.readyState==="loading") document.addEventListener("DOMContentLoaded", showHint, {once:true}); else showHint();
      }
    })();
    </script>
</body>
</html>
