<script>
  // ===== LIVE ENDPOINTS =====
  const BASE = "https://zendeskfunctionapp-egfydygfdmavfxg9.westus-01.azurewebsites.net";
  const PARCEL_URL = (v) =>
    `${BASE}/api/parcels/${encodeURIComponent(v)}?code=HvcyDqdJg3iCJT-xt4AZ0wtGvJALITMb8JFCwiIYFOmtAzFul9CJrA==`;
  const BILL_URL = (v) =>
    `${BASE}/api/bills/${encodeURIComponent(v)}?code=PE97g8PBfTUnpfFBOGi1rlHrW2Ht9alomPv0D7Ub08vWAzFuA0XlPA==`;

  // ===== UI helpers =====
  const $ = (id) => document.getElementById(id);
  function say(t, cls = "") {
    const e = $("m"); if (!e) return;
    e.className = "msg " + cls;
    e.textContent = t;
  }
  function setVal(v) {
    if (window.JFCustomWidget && typeof JFCustomWidget.setValue === "function") {
      JFCustomWidget.setValue(v);
    }
  }
  const debounce = (fn, ms) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; };

  async function getJson(url) {
    const res = await fetch(url, { method: "GET", mode: "cors", cache: "no-store" });
    let data = null; try { data = await res.json(); } catch { /* ignore */ }
    return { status: res.status, ok: res.ok, data };
  }

  async function validateRaw(raw) {
    const v = (raw || "").replace(/[^\d]/g, "").trim(); // digits only
    if (!v) { setVal(""); say("Enter a parcel or bill number."); return; }
    say("Validating…");
    try {
      // 1) Try parcel
      let r = await getJson(PARCEL_URL(v));
      if (r.ok && (r.data?.exists === true || r.data?.ok === true)) {
        const n = r.data.normalized || r.data.parcel || v;
        setVal(`parcel|${n}`); say("✓ Valid parcel", "ok"); return;
      }
      // 2) Try bill
      r = await getJson(BILL_URL(v));
      if (r.ok && (r.data?.exists === true || r.data?.ok === true)) {
        const n = r.data.normalized || r.data.bill || v;
        setVal(`bill|${n}`); say("✓ Valid bill", "ok"); return;
      }
      setVal(""); say("✗ Invalid number", "bad");
    } catch {
      setVal(""); say("⚠ Error contacting validator", "bad");
    }
  }

  // --- robust wiring that waits for the element ---
  function wireUp(input) {
    // Jotform lifecycle
    if (window.JFCustomWidget && typeof JFCustomWidget.subscribe === "function") {
      JFCustomWidget.subscribe("ready",  () => setVal(""));
      JFCustomWidget.subscribe("submit", () => JFCustomWidget.sendSubmit(true));
    } else {
      const hint = $("standaloneHint"); if (hint) hint.style.display = "block";
    }

    const validate = debounce(validateRaw, 250);
    input.addEventListener("input",  e => validate(e.target.value));
    input.addEventListener("change", e => validate(e.target.value));
    input.addEventListener("blur",   e => validate(e.target.value));
  }

  function init() {
    const inputNow = $("num");
    if (inputNow) { wireUp(inputNow); return; }

    // If #num isn't in the DOM yet (e.g., embedded / injected later), observe until it appears
    const obs = new MutationObserver(() => {
      const el = $("num");
      if (el) {
        obs.disconnect();
        wireUp(el);
      }
    });
    obs.observe(document.documentElement, { childList: true, subtree: true });

    // Also give users a console hint if it never shows up
    setTimeout(() => {
      if (!$("num")) console.warn("Validator: waiting for #num to be injected…");
    }, 500);
  }

  // Always schedule init safely
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init, { once: true });
  } else {
    // Queue to ensure any synchronous DOM injections complete first
    setTimeout(init, 0);
  }
</script>
