<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Bill Validator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font: 14px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; margin:0; padding:10px }
    label{ font-weight:600; display:block; margin:0 0 6px }
    input{ width:100%; padding:8px; box-sizing:border-box; border:1px solid #ccc; border-radius:8px }
    .msg { margin-top:6px; min-height:1.1rem; font-size:12px }
    .ok  { color:#156c1e } .bad{ color:#9f1d1d }
  </style>
  <script src="https://js.jotform.com/JFCustomWidget.min.js"></script>
</head>
<body>
  <label for="bill">Bill Number</label>
  <input id="bill" placeholder="Enter bill number" inputmode="numeric" autocomplete="off" />
  <div id="m" class="msg">We’ll verify this before you submit.</div>

  <script>
    const BASE = "https://zendeskfunctionapp-egfydygfdmavfxg9.westus-01.azurewebsites.net";
    const URL  = (v) => `${BASE}/api/public/bills/${encodeURIComponent(v)}`;

    const $ = (id)=>document.getElementById(id);
    const digits = (s)=> (s||"").replace(/[^\d]/g,"").trim();
    const say = (t,c="")=>{ const m=$("m"); m.className="msg "+c; m.textContent=t; };
    const debounce=(f,ms=250)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>f(...a),ms); }; };

    let normalized = "";   // <- the SINGLE value this widget submits
    let valid = false;

    function push(){
      JFCustomWidget.setValue(normalized || "");
      JFCustomWidget.setRequired(false);
      JFCustomWidget.setValidity(true);
      console.log("[Bill] setValue:", normalized);
    }

    async function validate(raw){
      const v = digits(raw);
      if (!v){ normalized=""; valid=false; say("Enter a bill number or leave blank if none."); return push(); }
      say("Validating bill…");
      try{
        const r = await fetch(URL(v), { method:"GET", mode:"cors", cache:"no-store" });
        const data = await r.json().catch(()=> ({}));
        if (r.ok && (data.exists===true || data.ok===true)){
          normalized = data.normalized || data.bill || v;
          valid = true; say("✓ Valid bill","ok");
        } else {
          normalized = ""; valid = false; say("✗ Invalid bill number.","bad");
        }
      } catch {
        normalized = ""; valid = false; say("⚠ Error contacting validator.","bad");
      }
      push();
    }

    const onInput = debounce(e=>validate(e.target.value), 250);

    JFCustomWidget.subscribe("ready", ()=> push());
    JFCustomWidget.subscribe("submit", ()=> JFCustomWidget.sendSubmit(true));

    $("bill").addEventListener("input", onInput, true);
  </script>
</body>
</html>
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Bill Validator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font: 14px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; margin:0; padding:10px }
    label{ font-weight:600; display:block; margin:0 0 6px }
    input{ width:100%; padding:8px; box-sizing:border-box; border:1px solid #ccc; border-radius:8px }
    .msg { margin-top:6px; min-height:1.1rem; font-size:12px }
    .ok  { color:#156c1e } .bad{ color:#9f1d1d }
  </style>
  <script src="https://js.jotform.com/JFCustomWidget.min.js"></script>
</head>
<body>
  <label for="bill">Bill Number</label>
  <input id="bill" placeholder="Enter bill number" inputmode="numeric" autocomplete="off" />
  <div id="m" class="msg">We’ll verify this before you submit.</div>

  <script>
    const BASE = "https://zendeskfunctionapp-egfydygfdmavfxg9.westus-01.azurewebsites.net";
    const URL  = (v) => `${BASE}/api/public/bills/${encodeURIComponent(v)}`;

    const $ = (id)=>document.getElementById(id);
    const digits = (s)=> (s||"").replace(/[^\d]/g,"").trim();
    const say = (t,c="")=>{ const m=$("m"); m.className="msg "+c; m.textContent=t; };
    const debounce=(f,ms=250)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>f(...a),ms); }; };

    let normalized = "";   // <- the SINGLE value this widget submits
    let valid = false;

    function push(){
      JFCustomWidget.setValue(normalized || "");
      JFCustomWidget.setRequired(false);
      JFCustomWidget.setValidity(true);
      console.log("[Bill] setValue:", normalized);
    }

    async function validate(raw){
      const v = digits(raw);
      if (!v){ normalized=""; valid=false; say("Enter a bill number or leave blank if none."); return push(); }
      say("Validating bill…");
      try{
        const r = await fetch(URL(v), { method:"GET", mode:"cors", cache:"no-store" });
        const data = await r.json().catch(()=> ({}));
        if (r.ok && (data.exists===true || data.ok===true)){
          normalized = data.normalized || data.bill || v;
          valid = true; say("✓ Valid bill","ok");
        } else {
          normalized = ""; valid = false; say("✗ Invalid bill number.","bad");
        }
      } catch {
        normalized = ""; valid = false; say("⚠ Error contacting validator.","bad");
      }
      push();
    }

    const onInput = debounce(e=>validate(e.target.value), 250);

    JFCustomWidget.subscribe("ready", ()=> push());
    JFCustomWidget.subscribe("submit", ()=> JFCustomWidget.sendSubmit(true));

    $("bill").addEventListener("input", onInput, true);
  </script>
</body>
</html>
